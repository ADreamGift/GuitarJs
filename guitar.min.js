/**
 * @author Vineet Naik, 
 * naikvin at gmail dot com, 
 * http://vineetnaik.me
 * @naiquevin
 * 
 * GuitarJS is a small library for playing with basic music theory
 * related stuff in javascript 
 * such as notes, chords and scales and extended for a 6 string guitar
 * for finding all possible voicings of a chord.
 *//**
 *  variables accessible in global context
 *  [Notes, Chord, ScaleFactory, Guitar]
 */(function(){function a(a,b){for(var c=0;c<b.length;c++)if(a===b[c])return!0;return!1}var b=b||window,c=b.Notes=c||{names:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],_rearrangeNotes:function(a){var b=null;for(var c=0;c<12;c++)if(this.names[c]===a){b=c;break}if(b===null)throw"Root note out of limit and invalid";return this.names.slice(b-12).concat(this.names.slice(0,b))},_sharpen:function(a){var b=this._rearrangeNotes(a);return b[1]},_flatten:function(a){var b=this._rearrangeNotes(a);return b[11]},_validate:function(b){return a(b,this.names)},slugify:function(a){if(!this._validate(a))throw new Error("Invalid note "+a);return a.toLowerCase().replace("#","-sharp")},unslugify:function(a){var b=a.replace("-sharp","#").toUpperCase();if(!this._validate(b))throw new Error("Invalid note "+b);return b}},d=b.Chord=d||{TYPES:[{name:"major",code:"Maj",refScale:"major",notes:[1,3,5]},{name:"minor",code:"Min",refScale:"major",notes:[1,"b3",5]},{name:"augmented",code:"Aug",refScale:"major",notes:[1,3,"#5"]},{name:"diminished",code:"Dim",refScale:"major",notes:[1,"b3","b5"]}],_getProperties:function(a){for(var b in this.TYPES)if(a===this.TYPES[b].code)return this.TYPES[b]},build:function(a){var b=[],d=a.split(" "),f=d[0],g=d[1],h=this._getProperties(g),i=e.getScale(f,h.refScale);i.load();for(var j=0;j<h.notes.length;j++)switch(typeof h.notes[j]){case"number":var k=i.notes[h.notes[j]-1];b.push(k);break;case"string":var k=i.notes[h.notes[j].substr(1)-1];h.notes[j].charAt(0)==="b"?b.push(c._flatten(k)):h.notes[j].charAt(0)==="#"&&b.push(c._sharpen(k))}return{name:a,notes:b}}},e=b.ScaleFactory={getScale:function(a,b){switch(a){case"major":default:return new f.Major(a)}}},f=f||{};f.abs=function(){this.root,this.formula,this.notes=[],this.off=[],this.toString},f.abs.prototype.toString=function(){var a="^";return this.notes.join(a)},f.abs.prototype.load=function(){this.notes=c._rearrangeNotes(this.root);for(var a=0;a<this.off.length;a++)this.notes.splice(this.off[a]-a,1)},f.Major=function(a){this.root=a,this.off=[1,3,6,8,10],this.formula="r~ W W H W W W H"},f.Major.prototype=new f.abs;var g=b.Guitar=g||{};g.Fretboard=function(){var a=[null,"E","B","G","D","A","E"],b=[null];for(var d=1;d<=6;d++){var e=[],f=a[d],g=c._rearrangeNotes(f);for(var h=0;h<g.length;h++)e.push(g[h]);for(var h=0;h<g.length;h++)e.push(g[h]);e.push(f),b.push(e)}return{fretMap:b,findOccurrences:function(a){var c=[null];for(var d=1;d<b.length;d++){var e=[];for(var f=0;f<b[d].length;f++)if(b[d][f]===a){e.push(f);while(f<=12)f+=12,e.push(f);break}c.push(e)}return c}}}(),g.Chord=function(a){this.notes=d.build(a).notes,this.root=this.notes[0],this.occ=g.Fretboard.findOccurrences(this.root),this.init()},g.Chord.prototype={init:function(){this.first=!0,this.string=6,this.fret_index=0},has_next:function(){var a=this.string,b=this.fret_index;return this.first?!0:(typeof this.occ[this.string][this.fret_index+1]!="undefined"?b++:(b=0,a--),!this.occ[a]||typeof this.occ[a][b]=="undefined"?!1:!0)},_compute_next_pos:function(){if(this.first){this.first=!1;return}typeof this.occ[this.string][this.fret_index+1]!="undefined"?this.fret_index++:(this.fret_index=0,this.string--)},next:function(){return this._compute_next_pos(),this.fret=this.occ[this.string][this.fret_index],this._build([this.string,this.fret],[0,4])},_build:function(a,b){var c=a[0],d=a[1],e={};e[c]=d;for(var f in this.notes){var h=g.Chord._find_notes_in_proximity({note:this.root,pos:a},this.notes[f],b);for(var i in h)e[i]?e[i]=Math.abs(d-e[i])<Math.abs(d-h[i])?e[i]:h[i]:e[i]=h[i]}return e}},g.Chord._find_notes_in_proximity=function(a,b,c){var d=g.Fretboard.findOccurrences(b),e=a.pos[0],f=a.pos[1],h=f+c[0],i=f+c[1],j={};for(var k=6;k>0;k--){if(k===e)continue;positions=d[k];for(var l=0;l<positions.length;l++)positions[l]>=h&&positions[l]<=i&&(j[k]=positions[l])}return j},g.Chord.create=function(a){return new g.Chord(a)}})();